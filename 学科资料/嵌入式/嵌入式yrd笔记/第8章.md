### 一、通用定时器（TIM2、TIM3）
#### （一）特点
1. **核心架构**
    - 配备16位向上/向下/中央对齐计数模式的计数器。
    - 拥有16位可编程预分频器（PSC），其分频系数取值范围为1 - 65536，可对时钟进行分频处理。
    - 具备4个独立通道，能够支持输入捕获、输出比较、PWM生成（包括边缘对齐和中间对齐模式）以及单脉冲输出等功能。
    - 支持外部触发控制、定时器级联同步，还能产生更新、触发、输入捕获、输出比较等中断和DMA请求。
2. **典型应用场景**：可用于定时控制、外部脉冲计数、波形测量（如脉宽、频率）、电机调速（通过PWM）以及编码器接口等方面。

#### （二）核心功能解析
1. **定时功能**
    - **原理**：利用内部时钟（CK_INT），通过预分频器（PSC）对时钟进行分频，得到计数时钟(计数时钟频率 = CK_INT / (PSC + 1))。计数器按照设定的模式（向上/向下）进行计数，当计数值达到自动重装载值（ARR）时，会触发更新事件（如中断）。
向上计数：从 0 开始，每次 + 1，直到达到 ARR 值。
向下计数：从 ARR 开始，每次 - 1，直到归零。
中心对齐：先向上计数，再向下计数，形成对称波形。

向上计数模式下：计数器归零，触发更新事件。
向下计数模式下：计数器重置为 ARR，触发更新事件。

- **初始化关键参数设置**
        - **预分频器（PSC）**：其值为分频系数减1。例如，若系统时钟为72MHz，当PSC设为7199时，计数时钟频率为 $\frac{72\text{MHz}}{7200} = 10\text{kHz}$。
        - **自动重装载值（ARR）**：用于设定定时周期。当ARR设为999时，定时时间为 $\frac{1000}{10\text{kHz}} = 0.1\text{s}$。
        - **计数模式**：通常选择向上计数模式。
    - **代码实现（以TIM2定时0.1s为例）**
        ```c
        // 初始化配置
        TIM_HandleTypeDef htim2;
        htim2.Instance = TIM2;
        htim2.Init.Prescaler = 7200 - 1;       // 分频系数7200
        htim2.Init.CounterMode = TIM_COUNTERMODE_UP;
        htim2.Init.Period = 1000 - 1;          // 自动重装载值1000
        htim2.Init.AutoReloadPreload = TIM_AUTORELOAD_PRELOAD_ENABLE;
        HAL_TIM_Base_Init(&htim2);

        // 启动定时器（中断方式）
        HAL_TIM_Base_Start_IT(&htim2);

        // 中断回调函数
        void HAL_TIM_PeriodElapsedCallback(TIM_HandleTypeDef *htim) {
            if (htim->Instance == TIM2) {
                HAL_GPIO_TogglePin(GPIOB, GPIO_PIN_0);  // 翻转LED引脚
            }
        }

        
        ```
2. **计数功能(定时器里面的计数器)**
    - **原理**：将外部信号接入TIMx_CHx或TIMx_ETR引脚，以外部信号的边沿（上升沿或下降沿）作为计数触发条件。
    - **配置要点**：需在STM32CubeMX中选择外部时钟模式（如外部时钟模式1，使用TIx引脚），并设置触发边沿（如上升沿）。
    - **示例**：对按键输入的脉冲进行计数，可通过查询TIMx->CNT寄存器的值来获取计数值。
3. **捕获功能（输入捕获）**
    - **原理**：当检测到TIMx_CHx引脚上的电平发生跳变（如上升沿或下降沿）时，会将当前计数器的值（TIMx_CNT）锁存到捕获/比较寄存器（TIMx_CCRx）中，以此来测量脉冲宽度或频率。
    - **配置要点**：在STM32CubeMX中选择输入捕获模式，设置触发边沿（如上升沿）和捕获分频器。
    - **示例**：测量按键按下的脉宽，通过两次捕获的时间差来计算脉宽。
4. **PWM功能（脉冲宽度调制）**
    - **概念**：通过调节脉冲的占空比（高电平持续时间与周期的比值），来等效模拟出所需的电压或电流值。例如，在直流电机调速中，占空比越大，电机转速越快。
    - **原理**
        - 计数器在时钟驱动下进行计数，当计数值小于比较值（CCRx）时，输出高电平；当计数值大于或等于比较值时，输出低电平。
        - **周期**：由自动重装载值（ARR）决定，即 $\text{周期} = \frac{(\text{ARR} + 1)}{\text{计数时钟频率}}$。
        - **占空比**：计算公式为 $\text{占空比} = \frac{\text{CCRx}}{\text{ARR} + 1}$。
    - **电压值计算**：假设输出为高电平时的电压为 $V_{\text{CC}}$，则PWM输出的等效电压为 $V_{\text{out}} = V_{\text{CC}} \times \text{占空比}$。例如，当 $V_{\text{CC}} = 3.3\text{V}$，占空比为50%时，等效电压为1.65V。
    - **代码示例（TIM3输出占空比60%的PWM）**
        ```c
        // 初始化配置
        TIM_OC_InitTypeDef sConfigOC;
        htim3.Instance = TIM3;
        htim3.Init.Prescaler = 36 - 1;       // 分频系数36，计数时钟频率为2MHz
        htim3.Init.Period = 1000 - 1;        // 周期为0.5ms（2kHz）
        HAL_TIM_PWM_Init(&htim3);

        // 配置通道2的PWM参数
        sConfigOC.OCMode = TIM_OCMODE_PWM1;
        sConfigOC.Pulse = 600;               // 比较值，占空比为60%（600/1000）
        sConfigOC.OCPolarity = TIM_OCPOLARITY_HIGH;
        HAL_TIM_PWM_ConfigChannel(&htim3, &sConfigOC, TIM_CHANNEL_2);

        // 启动PWM输出
        HAL_TIM_PWM_Start(&htim3, TIM_CHANNEL_2);
        ```


### 二、滴答定时器（SysTick）
#### （一）作用与功能
1. **系统时基**：作为操作系统（如RTOS）的心跳时钟，用于产生周期性的中断（滴答中断），为任务调度、延时函数（如`HAL_Delay`）提供时间基准。
2. **硬件特性**
    - 是一个24位向下计数器，当计数值减到0时，会自动从重装寄存器中重新加载数值。
    - 时钟源可以是系统时钟（HCLK）或其分频时钟（如HCLK/8），通过`SYSTICK_CTRL`寄存器进行配置。
    - 支持中断功能，当中断使能时，每次计数到0都会触发SysTick中断。
3. **典型应用**：实现精准延时、统计程序执行时间、为操作系统提供周期性的调度信号。


### 三、实时时钟（RTC）
#### （一）作用与功能
1. **独立计时**：能够在系统断电后，依靠备用电池（VBAT）维持计时，可提供年、月、日、时、分、秒等时间信息。
2. **核心特性**
    - 采用32位计数器，计时精度高，支持秒中断（每1秒触发一次中断）和闹钟中断（可设定特定时间触发中断）。
    - 时钟源可选低速外部晶振（LSE，32.768kHz）、低速内部RC（LSI，约40kHz）或高速外部时钟分频（HSE/128）。
    - 数据存储在备份区域（BKP），该区域在系统复位或掉电后数据不会丢失，用于保存RTC配置和时间数据。
3. **典型应用**：为系统提供实时时间戳、实现定时唤醒（如从待机模式唤醒）、记录事件发生时间等。


### 四、看门狗定时器（WDT）
#### （一）作用与功能
- **防止程序跑飞**：通过监测程序的运行状态，当程序因干扰或bug陷入死循环时，看门狗会触发系统复位，使程序恢复正常运行。
- **分类**：包括独立看门狗（IWDG）和窗口看门狗（WWDG），下面重点介绍独立看门狗。

#### （二）独立看门狗（IWDG）
1. **特性**
    - **独立时钟**：使用内部独立的40kHz RC振荡器（与主时钟无关），即便主时钟失效，它依然能正常工作。
    - **12位计数器**：为递减计数器，计数值范围是0 - 4095。
    - **喂狗机制**：需要定期向键值寄存器（IWDG_KR）写入`0xAAAA`来重置计数器，若计数器减到0仍未喂狗，就会触发系统复位。
2. **关键寄存器**
    - **IWDG_KR**：用于写入控制命令，如`0x5555`（解除写保护）、`0xAAAA`（喂狗）、`0xCCCC`（启动看门狗）。
    - **IWDG_PR**：预分频器寄存器，用于设置分频系数（如4分频、8分频等），从而调整计数周期。
    - **IWDG_RLR**：重装载寄存器，用于设置计数器的初始值。
3. **配置步骤**
    1. 解除写保护：向`IWDG_KR`写入`0x5555`。
    2. 设置预分频器（PR）和重装载值（RLR）：例如，当PR设为4分频，RLR设为4095时，计数周期为 $\frac{4095 \times 4}{40\text{kHz}} \approx 0.4095\text{s}$。
    3. 启动看门狗：向`IWDG_KR`写入`0xCCCC`。
    4. 在程序中定期喂狗：在合适的位置写入`0xAAAA`，确保计数器不会溢出。
4. **典型应用场景**：适用于对时间精度要求不高，但需要独立于主系统进行故障检测的场景，如工业控制、嵌入式设备的异常复位保护等。


### 总结
- **通用定时器**：是STM32的核心外设之一，通过灵活配置预分频器、计数器模式和通道功能，可实现定时、计数、捕获和PWM输出等多种功能，广泛应用于各类控制场景。
- **SysTick**：为系统提供了统一的时基，是实现延时和操作系统调度的基础。
- **RTC**：能够在断电后维持时间，是需要实时时间信息的系统（如智能设备、记录仪）的必备组件。
- **独立看门狗**：作为系统的“硬件保镖”，通过简单的喂狗机制，有效防止程序跑飞，提高了系统的可靠性。