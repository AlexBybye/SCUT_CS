### 一、开发流程：四阶段系统化设计
#### 1. 需求分析阶段
- **功能定位**：明确小车需实现电位器调速、超声波避障、温度检测、轮速PID控制、OLED显示等功能。
- **性能权衡**：选用STM32F103R6主控芯片，在处理速度（72MHz主频）与成本（低功耗Cortex-M3内核）间寻求平衡。
- **规格约束**：限定小车尺寸（适配标准开发板）、功耗（电池供电，需启用低功耗模式）。

#### 2. 方案设计阶段
- **体系结构**：确定采用**软实时系统**（非强实时任务），硬件划分为主控、传感器、执行器模块，软件采用模块化设计。
- **硬件框架**：规划STM32最小系统（电源、时钟、复位），并连接电位器（ADC）、DS18B20（单总线）、超声波模块（GPIO+定时器）等外设。
- **软件架构**：裸机方案采用“主程序+中断”模式，主程序负责循环处理显示、测距等任务，中断处理轮速脉冲计数与PID控制。

#### 3. 科研开发阶段
- **平台选择**：硬件开发借助Proteus进行仿真，软件开发使用Keil MDK，编程语言为C语言，采用HAL库简化驱动开发。
- **硬件实现**：完成原理图设计（如STM32最小系统、L293D电机驱动电路）、PCB制版、焊接调试，重点确保电源稳定性与信号抗干扰性（如DS18B20上拉电阻配置）。
- **软件开发**：
    - 交叉编译环境搭建：配置Keil MDK工程，适配STM32F103R6芯片，启用ADC、TIM、USART等外设驱动。
    - 模块开发：依次编写ADC采集（电位器电压）、DS18B20温度读取（模拟单总线时序）、超声波测距（定时器捕获脉冲宽度）、OLED驱动（SPI串行通信）等代码。

#### 4. 系统测试阶段
- **硬件测试**：检测各模块供电是否正常（如L293D的5V/3.3V电源）、接口连通性（用万用表测量引脚阻抗）。
- **软件测试**：
    - 黑盒测试：手动调节电位器，观察车速是否线性变化；遮挡超声波传感器，测试小车是否停车报警。
    - 白盒测试：通过串口打印PID控制参数（如误差、积分值），验证算法逻辑正确性。
- **协同测试**：模拟复杂场景，如低速行驶时检测温度与避障功能的并行运行，确保软硬件协同无冲突。


### 二、硬件设计：模块化工件与电路实现
#### 1. 主控模块（STM32F103R6）
- **核心电路**：配置8MHz外部晶振（经PLL倍频至72MHz）、10kΩ复位电阻、BOOT0引脚接地（从Flash启动）。
- **接口分配**：
    - PA4：连接电位器，用于ADC采集调速电压。
    - PA11：连接DS18B20的DQ引脚，模拟单总线通信。
    - PA5/PA6：连接超声波模块的TR/ECH引脚，控制测距触发与回声捕获。
    - PB2：连接蜂鸣器，通过GPIO翻转控制发声。

#### 2. 传感器模块
- **电位器调速**：采用10kΩ滑动变阻器，输出电压范围0~3.3V，经ADC转换为12位数字量（0~4095），作为轮速设定值。
- **温度检测**：DS18B20通过4.7kΩ上拉电阻连接至3.3V，单总线协议实现温度读取（精度±0.5℃）。
- **超声波测距**：HCSR04模块通过TR触发10μs脉冲，ECH输出高电平宽度对应障碍物距离，计算公式为：  
  $$距离D=声速C×时间T/2（C=340m/s）$$

#### 3. 执行器模块
- **电机驱动**：L293D双桥驱动芯片控制前后轮电机，IN1/IN3引脚接收STM32的PWM信号（PA8输出），通过ENA使能端调节转速，逻辑真值表如下：

| IN1 | IN2 | 电机状态 |
|-----|-----|----------|
| 0   | 1   | 顺时针转动 |
| 1   | 0   | 逆时针转动 |
| 0   | 0   | 停止     |

- **显示与报警**：OLED屏（HDG12864F-1）通过SPI接口（PB6/PB7）显示温度、距离、车速；蜂鸣器由PB2引脚直接驱动，高电平触发鸣叫。


### 三、软件设计：裸机与操作系统双方案
#### 1. 裸机程序设计（主程序+中断）
- **主程序流程**：
    1. 初始化外设：ADC、TIM1（轮速计数）、TIM3（超声波捕获）、USART（串口调试）、OLED。
    2. 循环执行：
        - 调用ADC函数读取电位器值，计算目标车速 $V_{set}$。
        - 调用DS18B20函数获取温度 $T$，超声波函数获取距离 $D$。
        - 调用OLED显示函数，更新界面数据。
        - 若 $D < 10cm$，则关闭电机PWM输出，触发蜂鸣器报警。
- **中断处理**：
    - **TIM2定时中断**：周期100ms，触发PID控制算法，根据实测车速 $V_{meas}$ 与 $V_{set}$ 的误差，计算PWM占空比，更新PA8输出。
    - **TIM1外部触发中断**：捕获电机码盘脉冲（PA12引脚），计算实际轮速 $V_{meas}$。

#### 2. PID控制算法实现
- **增量式PID公式**：  
  $$\Delta u(k)=K_p[e(k)-e(k-1)]+K_i e(k)+K_d[e(k)-2e(k-1)+e(k-2)]$$  
  其中，$e(k)$ 为当前误差（$V_{set}-V_{meas}$），通过TIM2中断周期（$T=0.1s$）更新参数。
- **参数调优**：
    - $K_p$：快速响应误差，过大易导致振荡。
    - $K_i$：消除稳态误差，过大可能引发积分饱和。
    - $K_d$：抑制超调，改善动态性能。

#### 3. 嵌入式操作系统方案（以μC/OS-II为例）
- **任务划分**：将功能拆分为9个任务，设置优先级如下：

| 任务名称       | 优先级 | 功能描述                     |
|----------------|--------|------------------------------|
| 超声波测距任务 | 最高   | 周期性触发测距，更新距离数据 |
| 轮速控制任务   | 次高   | 处理PID计算与PWM输出         |
| 温度采集任务   | 中等   | 读取DS18B20温度数据          |
| OLED显示任务   | 中等   | 刷新界面显示                  |
| 串口调试任务   | 较低   | 输出调试信息                  |
| 蜂鸣器控制任务 | 最低   | 响应避障事件，控制鸣叫        |

- **任务通信**：通过信号量（Semaphore）同步测距结果与避障逻辑，利用消息队列（Message Queue）传递温度、车速数据至显示任务。


### 四、关键技术总结
- **硬件协同**：合理布局传感器与执行器电路，减少信号干扰（如电机驱动与主控模块电源隔离）。
- **软件优化**：裸机方案需注意中断优先级避免嵌套冲突；操作系统方案需平衡任务数量与实时性，避免资源竞争。
- **测试验证**：通过Proteus仿真提前验证电路逻辑（如超声波模块时序），结合串口调试实时监控参数，缩短调试周期。

通过以上流程，可系统化完成从需求分析到软硬件实现的嵌入式系统开发，确保功能可靠性与性能指标达标。